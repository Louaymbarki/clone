"use strict";(()=>{function m(i){document.documentElement.dispatchEvent(new window.CustomEvent("tactiq-message",{detail:i}))}function a(i,...l){console.log(`[Tactiq] ${i}`,...l)}function b(i,l){let o=!1,C=new MutationObserver(function(p){p.forEach(function(){let y=i();y&&!o&&(o=!0,C.disconnect(),l(y))})});C.observe(document,{childList:!0,subtree:!0})}async function I(i){return new Promise(function(l){setTimeout(l,i)})}async function w(i,l){for(;i.isConnected;)await I(250);l()}async function f(i,l){for(;;){let o=i();if(o){l&&l(o);break}await I(250)}}(function(){let i=!1,l,o=[];function C(e,n){for(let t in e)if(t.startsWith("jQuery")){let c=e[t];if(!n||n(c))return c}}function p(e){m({type:"meeting-id",data:e})}function y(e,n){m({type:"msteams-organiser",meetingId:e,isOrganiser:n})}setInterval(()=>{if(o.length){let e=[...o];o=[],m({type:"speech",messages:e})}},500);function M(e){let n=o.findIndex(t=>t.messageId===e.messageId);n>-1?o[n].messageVersion<=e.messageVersion&&o.splice(n,1,e):o.push(e)}let v={};function E(e){if("timestampAudioSent"in e&&e.timestampAudioSent)return`${e.timestampAudioSent}/${e.userId}`;{let[,n]=e.id.split("/"),t=v[e.userId];return e.isFinal?t?(v[e.userId]=void 0,`${t}/${e.userId}`):`${n}/${e.userId}`:t?`${t}/${e.userId}`:(v[e.userId]=n,`${n}/${e.userId}`)}}function S(e,n){if(!n.startClosedCaption)return;i&&m({type:"debug",data:JSON.stringify(e)});let[,t]=e.id.split("/"),c=E(e),r=n.participants.find(u=>u.mri===e.userId),s=r?.displayName?r.displayName:n.getSelfParticipant().$$state.value.displayName;return{deviceId:e.userId,deviceName:s,messageId:c,messageVersion:parseInt(t),text:e.text,languageCode:n.getClosedCaptionsLanguage()}}let g;async function L(e){a("Meeting started",e),v={};let n=document.querySelector("iframe.embedded-electron-webview"),t=n&&window.location.hash.includes("modern-calling");a(t?"Modern calling detected":"Classic calling detected",n);let c=r=>{let s=r.data?.payload?.dataLayer?.data?.closedCaptionsEntryEvent,u=r.data?.payload?.dataLayer?.data?.closedCaptionsDynamicEntryEvent;if(s){let d=S(s,e.call);d&&M(d)}else if(u){let d=S(u,e.call);d&&M(d)}else i&&a("DEBUG",r.data)};if(e.call.startClosedCaption){a("Closed captions are available"),p(e.call._callId),g=e.call;let r=e.call.getCallingConversation&&e.call.getCallingConversation()?.meetingInfo;r&&m({type:"title-updated",title:r.subject}),a("Waiting for the call to connect..."),await f(()=>e.call.callGotConnected&&e.call.audioStreamState),a("Call connected"),a("Starting closed captions..."),e.call.startClosedCaption(),await f(()=>e.call.closedCaptionsHaveBeenStarted()&&e.call.getClosedCaptionStatus()===2),a("Started closed captions"),t?(a("Waiting for the modern calling to get ready"),f(()=>n.contentWindow,s=>{a("Configuring modern calling for Tactiq...",s),s.addEventListener("message",c),a("Configured modern calling for Tactiq")}),f(()=>g?.role,s=>{g&&y(g._callId,s==="admin")})):(a("Configuring classic calling for Tactiq"),b(()=>{let s=document.getElementsByTagName("calling-closed-captions");if(s.length)return s[0]},s=>{let u=C(s).$callingClosedCaptionsController;l||(l=u.adapter.handler),u.adapter.handler=function(){let d=S(arguments[0],e.call);return d&&M(d),l.apply(this,arguments)}}))}else a("Closed captions are NOT available",e.call);if(t)f(()=>e.callingService.getActiveCall?e.callingService.getActiveCall()===null:e.callingService.callRegistry.calls.length===0,()=>{n.contentWindow?.removeEventListener("message",c),a("Modern calling meeting ended"),p(void 0),g=void 0,setTimeout(T,5e3)});else{let r=document.getElementsByTagName("calling-screen")[0];w(r,()=>{a("Classic calling meeting ended"),p(void 0),g=void 0,T()}).catch(s=>console.error(s))}}function T(){a("Waiting for an active call..."),f(()=>{let e=C(document.documentElement,n=>"$ngControllerController"in n)?.$ngControllerController;if(e&&e.callingService?.callRegistry?.calls?.length)if(e.callingService.getActiveCall){let n=e.callingService.getActiveCall();return n?{call:n,callingService:e.callingService}:void 0}else{let{lastOrCurrentCallInfo:n}=e.callingService;if(!n)return;let t=e.callingService.callRegistry.calls.find(c=>c._callId===n.callId);return t?{call:t,callingService:e.callingService}:void 0}},L)}function R(){document.documentElement.addEventListener("tactiq-rtc",async n=>{let t=n.detail;switch(t.type){case"debug":!i&&t.enabled?a("Debug mode enabled"):i&&!t.enabled&&a("Debug mode disabled"),i=t.enabled;break;case"lang":g?.setClosedCaptionsLanguage(t.languageCode);break;default:console.debug(t);break}});let e=document.createElement("meta");return e.setAttribute("id","tactiq-rtc"),e.setAttribute("name","tactiq-rtc"),(document.head||document.documentElement).prepend(e),T(),!0}window.tactiq||(window.tactiqRtc={}),window.tactiqRtc.gotRTC=R(),console.debug("Tactiq is Ready",window.tactiqRtc.gotRTC)})();})();
